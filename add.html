<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Music</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Upload Music</h1>
        <button id="back-to-main">Back to Main Page</button>
    </header>
    <main>
        <section id="upload-section">
            <h2>Upload Music</h2>
            <form id="upload-form" enctype="multipart/form-data">
                <label for="track-title">Track Title:</label>
                <input type="text" id="track-title" name="track-title" required>
                
                <label for="track-file">Track File:</label>
                <input type="file" id="track-file" name="track-file" accept="audio/*" required>
                
                <label for="track-photo">Track Photo:</label>
                <input type="file" id="track-photo" name="track-photo" accept="image/*" required>
                
                <label for="collection">Collection:</label>
                <select id="collection" name="collection">
                    <option value="none">No Collection</option>
                </select>
                <option value="new">Add New Collection</option>
                <input type="text" id="new-collection" placeholder="Enter new collection name" style="display: none;">

                <button type="submit">Upload</button>
            </form>
        </section>
        <section id="collections-list">
            <h2>Existing Collections</h2>
            <ul id="collections"></ul>
        </section>
    </main>
    <script src="script.js"></script>
    <script>
        function loadCollections() {
            fetch('/api/collections')
                .then(response => response.json())
                .then(data => {
                    const collectionsSelect = document.getElementById('collection');
                    const collectionsList = document.getElementById('collections');
                    collectionsSelect.innerHTML = '<option value="none">No Collection</option><option value="new">Add New Collection</option>';
                    collectionsList.innerHTML = '';

                    data.forEach(collection => {
                        const option = document.createElement('option');
                        option.value = collection.name;
                        option.textContent = collection.name;
                        collectionsSelect.appendChild(option);

                        const li = document.createElement('li');
                        li.textContent = collection.name;
                        collectionsList.appendChild(li);
                    });
                })
                .catch(error => console.error('Error fetching collections:', error));
        }

        document.getElementById('collection').addEventListener('change', function() {
            const newCollectionInput = document.getElementById('new-collection');
            if (this.value === 'new') {
                newCollectionInput.style.display = 'inline';
            } else {
                newCollectionInput.style.display = 'none';
            }
        });

        document.getElementById('upload-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const trackTitle = document.getElementById('track-title').value;
            const trackFile = document.getElementById('track-file').files[0];
            const trackPhoto = document.getElementById('track-photo').files[0];
            let collectionName = document.getElementById('collection').value;

            if (collectionName === 'new') {
                collectionName = document.getElementById('new-collection').value.trim();
            }

            if (trackFile && trackPhoto && trackTitle) {
                const formData = new FormData();
                formData.append('track-title', trackTitle);
                formData.append('track-file', trackFile);
                formData.append('track-photo', trackPhoto);
                formData.append('collection', collectionName);

                fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert("Track uploaded successfully.");
                        loadCollections(); // Refresh collections list
                        window.location.href = "index.html"; // Redirect to main page
                    } else {
                        alert("Error uploading track: " + result.message);
                    }
                })
                .catch(error => console.error('Error uploading track:', error));
            }
        });

        document.getElementById('back-to-main').addEventListener('click', function() {
            window.location.href = "index.html";
        });

        document.addEventListener('DOMContentLoaded', loadCollections);
    </script>
</body>
</html>
